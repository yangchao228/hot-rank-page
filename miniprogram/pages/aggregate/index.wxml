<view class="page">
  <view class="card header">
    <view class="row">
      <view class="title">聚合热榜</view>
      <navigator url="/pages/settings/index" class="link">设置</navigator>
    </view>
    <view class="meta muted">服务端：{{baseUrl}}</view>

    <view class="controls">
      <view class="control">
        <view class="label muted">条数</view>
        <picker mode="selector" range="{{limitOptions}}" value="{{limitIndex}}" bindchange="onLimitChange">
          <view class="picker">{{limitOptions[limitIndex]}} 条</view>
        </picker>
      </view>

      <view class="control">
        <view class="label muted">来源</view>
        <button class="btn" size="mini" bindtap="toggleSourcePanel">{{selectedSourceIds.length}} / {{sources.length}}</button>
      </view>

      <view class="control">
        <view class="label muted">刷新</view>
        <button class="btn" size="mini" bindtap="refresh">拉取</button>
      </view>
    </view>

    <view wx:if="{{failedSources.length}}" class="warn">
      <text>部分来源失败：</text>
      <text class="warn-list">{{failedSources.join(', ')}}</text>
    </view>

    <view wx:if="{{error}}" class="error">
      <text>{{error}}</text>
    </view>
  </view>

  <view wx:if="{{showSourcePanel}}" class="card source-panel">
    <view class="row">
      <view class="subTitle">选择来源</view>
      <view class="muted">（未选则默认全源）</view>
    </view>

    <view class="panel-actions">
      <button class="btn" size="mini" bindtap="selectAll">全选</button>
      <button class="btn" size="mini" bindtap="clearAll">全不选</button>
      <button class="btn primary" size="mini" bindtap="applySources">应用并刷新</button>
    </view>

    <checkbox-group bindchange="onSourceChange">
      <view class="source-grid">
        <label class="source-item" wx:for="{{sources}}" wx:key="id">
          <checkbox value="{{item.id}}" checked="{{selectedSourceIds.includes(item.id)}}" />
          <view class="source-text">
            <view class="source-title">{{item.title}}</view>
            <view class="source-desc muted">{{item.type}}</view>
          </view>
        </label>
      </view>
    </checkbox-group>
  </view>

  <view class="list">
    <view wx:if="{{loading}}" class="muted loading">加载中...</view>
    <view wx:elif="{{!items.length}}" class="muted empty">暂无数据，下拉或点击“拉取”刷新</view>

    <view wx:for="{{items}}" wx:key="id" class="card item" bindtap="onItemTap" data-index="{{index}}">
      <view class="row">
        <view class="item-title">{{index + 1}}. {{item.title}}</view>
      </view>
      <view class="row sub">
        <view class="badge">{{sourceTitleMap[item.source] || item.source}}</view>
        <view wx:if="{{item.hot}}" class="hot">热度 {{item.hot}}</view>
        <view class="muted time">{{formatTime(item.timestamp)}}</view>
      </view>
      <view wx:if="{{item.desc}}" class="muted desc">{{item.desc}}</view>
    </view>
  </view>
</view>
